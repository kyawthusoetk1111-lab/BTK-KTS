/**
 * Core Philosophy: This ruleset enforces a strict, multi-tiered security model.
 * A core principle is path-based ownership, where a user's private data, such as quizzes and questions,
 * is stored in a hierarchical structure under their unique user ID. This provides strong, inherited
 * security guarantees. For globally accessible data like exam results, security is managed via a
 * denormalized `userId` field within the document itself, ensuring users can only access their own records.
 *
 * Data Structure:
 * - /users/{userId}/... : All user-specific data, including their profile, quizzes, sections, and questions,
 *   is nested under this path. This creates a secure data silo for each user.
 * - /passages/{passageId}/... : A top-level collection for public, read-only content that can be shared across quizzes.
 * - /examResults/{examResultId}: A top-level collection where each document represents a single exam attempt.
 *   Access is not path-based but is controlled by an internal `userId` field.
 *
 * Key Security Decisions:
 * - Default Deny: All paths are closed by default. Access must be explicitly granted.
 * - Strict Ownership: All data under `/users/{userId}` is strictly accessible only to the authenticated
 *   user whose UID matches `{userId}`.
 * - No User Listing: The rules do not allow for querying the top-level `/users` collection, preventing
 *   the exposure of the user base.
 * - Secure Result Handling: Users can create their own exam results and can only read, update, or delete
 *   their own. Listing the entire `examResults` collection is explicitly forbidden to prevent data leaks,
 *   requiring the client application to query specifically for the signed-in user's results.
 * - Public Read-Only Content: The `/passages` collection is publicly readable by any user, but all write
 *   operations are disabled to protect shared content integrity.
 *
 * Denormalization for Authorization:
 * To ensure high-performance and secure authorization, this ruleset relies on denormalization.
 * - Path-based Ownership: Instead of using `get()` calls to check ownership, the user's ID is part of the
 *   document path (e.g., `/users/{userId}/...`), making ownership checks instantaneous.
 * - Resource-Specific Roles: For `/examResults`, the `userId` is denormalized directly onto the document.
 *   This allows a simple rule (`resource.data.userId == request.auth.uid`) to secure the document without
 *   needing to query other collections.
 *
 * Structural Segregation:
 * The data model separates private user data (`/users/{userId}/quizzes`) from public shared data (`/passages`)
 * and semi-private user-centric data (`/examResults`). This segregation simplifies rules, improves query
 * performance, and enhances security by preventing accidental cross-collection data exposure.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the given userId.
     * This is the core of our path-based ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update and delete.
     * Ensures the operation targets a document that actually exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if a field is immutable during an update operation.
     * Prevents clients from changing critical relational keys like owner IDs.
     */
    function isImmutable(field) {
        return request.resource.data[field] == resource.data[field];
    }

    /**
     * Validates that the user creating an ExamResult is setting the owner to themselves.
     */
    function isCreatingOwnResult() {
      return isSignedIn() && request.resource.data.userId == request.auth.uid;
    }

    /**
     * Checks if the authenticated user owns the specified ExamResult document.
     */
    function isResultOwner() {
      return isSignedIn() && resource.data.userId == request.auth.uid;
    }

    /**
     * Checks if the authenticated user owns an existing ExamResult document.
     * Used for update and delete operations on results.
     */
    function isExistingResultOwner() {
      return resource != null && isResultOwner();
    }


    // -------------------------------------------------------------------------
    // User Data Rules
    // -------------------------------------------------------------------------

    /**
     * @description Users can create their own profile and can only read or write their own data.
     * @path /users/{userId}
     * @allow (create) a new user creating their own user document: auth.uid === userId.
     * @deny (get) an authenticated user trying to read another user's profile.
     * @principle Restricts access to a user's own data tree and allows self-creation of a user profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Disallow listing all users for security.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);

      /**
       * @description Quizzes are owned by the user. Only the owner can manage them.
       * @path /users/{userId}/quizzes/{quizId}
       * @allow (create, get, list, update, delete) an authenticated user operating on their own quizzes.
       * @deny (any) a user attempting to access another user's quizzes.
       * @principle Enforces strict path-based ownership inherited from the parent user document.
       */
      match /quizzes/{quizId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update, delete: if isExistingOwner(userId);

        /**
         * @description Sections are owned by the user who owns the quiz.
         * @path /users/{userId}/quizzes/{quizId}/sections/{sectionId}
         * @allow (any) an authenticated user operating on their own sections within their own quiz.
         * @deny (any) a user attempting to access sections in another user's quiz.
         * @principle Enforces strict path-based ownership inherited from the parent user document.
         */
        match /sections/{sectionId} {
          allow get, list: if isOwner(userId);
          allow create: if isOwner(userId);
          allow update, delete: if isExistingOwner(userId);

          /**
           * @description Questions are owned by the user who owns the quiz.
           * @path /users/{userId}/quizzes/{quizId}/sections/{sectionId}/questions/{questionId}
           * @allow (any) an authenticated user operating on their own questions.
           * @deny (any) a user attempting to access another user's questions.
           * @principle Enforces strict path-based ownership inherited from the parent user document.
           */
          match /questions/{questionId} {
            allow get, list: if isOwner(userId);
            allow create: if isOwner(userId);
            allow update, delete: if isExistingOwner(userId);

            /**
             * @description Answer options are owned by the user who owns the question.
             * @path /users/{userId}/quizzes/{quizId}/sections/{sectionId}/questions/{questionId}/answerOptions/{answerOptionId}
             * @allow (any) an authenticated user operating on their own answer options.
             * @deny (any) a user attempting to access another user's answer options.
             * @principle Enforces strict path-based ownership inherited from the parent user document.
             */
            match /answerOptions/{answerOptionId} {
              allow get, list: if isOwner(userId);
              allow create: if isOwner(userId);
              allow update, delete: if isExistingOwner(userId);
            }

            /**
             * @description Matching pairs are owned by the user who owns the question.
             * @path /users/{userId}/quizzes/{quizId}/sections/{sectionId}/questions/{questionId}/matching/{matchingId}
             * @allow (any) an authenticated user operating on their own matching pairs.
             * @deny (any) a user attempting to access another user's matching pairs.
             * @principle Enforces strict path-based ownership inherited from the parent user document.
             */
            match /matching/{matchingId} {
              allow get, list: if isOwner(userId);
              allow create: if isOwner(userId);
              allow update, delete: if isExistingOwner(userId);
            }
          }
        }
      }
    }


    // -------------------------------------------------------------------------
    // Public Content Rules
    // -------------------------------------------------------------------------

    /**
     * @description Passages are public, read-only content. Anyone can view them.
     * @path /passages/{passageId}
     * @allow (get, list) any user, signed in or not, to read passages.
     * @deny (create, update, delete) all write operations to protect shared content.
     * @principle Provides public read access while preventing modification by clients.
     */
    match /passages/{passageId} {
      allow get, list: if true;
      allow create: if false; // TODO: Implement admin or teacher role for creating passages.
      allow update: if false; // TODO: Implement admin or teacher role for updating passages.
      allow delete: if false; // TODO: Implement admin or teacher role for deleting passages.

      /**
       * @description Passage questions are public and read-only, inheriting from the parent passage.
       * @path /passages/{passageId}/passageQuestions/{passageQuestionId}
       * @allow (get, list) any user, signed in or not, to read passage questions.
       * @deny (create, update, delete) all write operations.
       * @principle Inherits public read-only access from the parent passage.
       */
      match /passageQuestions/{passageQuestionId} {
        allow get, list: if true;
        allow create: if false; // TODO: Implement admin or teacher role for writes.
        allow update: if false; // TODO: Implement admin or teacher role for writes.
        allow delete: if false; // TODO: Implement admin or teacher role for writes.
      }
    }

    // -------------------------------------------------------------------------
    // Results Rules
    // -------------------------------------------------------------------------

    /**
     * @description Users can create their own exam results and can only read/write their own records.
     * @path /examResults/{examResultId}
     * @allow (create) a signed-in student creating a result for themselves (request.resource.data.userId == auth.uid).
     * @deny (get) a student trying to read another student's exam result.
     * @deny (list) any user trying to list all results, which would be a data leak.
     * @principle Enforces document ownership for reads and writes using a `userId` field within the document.
     */
    match /examResults/{examResultId} {
      allow get: if isResultOwner();
      allow list: if false; // CRITICAL: Prevent listing all results. Client must query by userId.
      allow create: if isCreatingOwnResult();
      allow update: if isExistingResultOwner() && isImmutable('userId');
      allow delete: if isExistingResultOwner();
    }
  }
}